name: Secrets Guard

on:
  push:
  pull_request:

jobs:
  secrets-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fail if any .env* file is tracked
        run: |
          set -e
          if git ls-files | grep -E '(^|/)\.env(\.|$)' | grep -v -E '\.env\.example(\.|$)'; then
            echo "FAIL: .env files must not be tracked (only .env.example templates are allowed)"
            exit 1
          fi

      - name: Fail if common secret patterns appear in tracked files
        run: |
          set -e
          # Intentionally only match *value-like* secret formats to avoid flagging templates/docs.
          PATTERN='(sk_live_[A-Za-z0-9]{10,}|pk_live_[A-Za-z0-9]{10,}|sk_test_[A-Za-z0-9]{10,}|pk_test_[A-Za-z0-9]{10,}|gsk_[A-Za-z0-9]{10,}|re_[A-Za-z0-9]{10,}|vercel_blob_rw_[A-Za-z0-9_\-]{10,}|BEGIN (RSA|OPENSSH) PRIVATE KEY)'

          # Scan only tracked text-like files. Avoid scanning build artifacts.
          FILES=$(git ls-files \
            ':!**/.next/**' \
            ':!**/dist/**' \
            ':!**/build/**' \
            ':!**/node_modules/**' \
            ':!**/pnpm-lock.yaml' \
            ':!**/playwright-report/**' \
            ':!**/test-results/**' \
            ':!**/.env.example*' \
            ':!**/.env.production.example')

          if echo "$FILES" | xargs -r grep -nE "$PATTERN"; then
            echo "FAIL: Detected secret-like patterns in tracked files. Remove secrets and rotate keys."
            exit 1
          fi

          echo "PASS: No tracked .env files and no obvious secret patterns found."
